<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Multi-Provider Fraud Detection System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1e1e2e 0%, #2a2a3e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 2rem;
            background: rgba(30, 30, 46, 0.8);
            border-radius: 12px;
        }

        .header h1 {
            font-size: 2.5rem;
            color: #4a9eff;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: #b0b0b0;
            font-size: 1.1rem;
        }

        /* Upload Section */
        .upload-section {
            background: rgba(30, 30, 46, 0.8);
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
        }

        .upload-section h2 {
            color: #4a9eff;
            margin-bottom: 1.5rem;
        }

        .upload-area {
            border: 2px dashed #4a9eff;
            border-radius: 12px;
            padding: 3rem;
            text-align: center;
            background: rgba(74, 158, 255, 0.05);
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 1rem;
        }

        .upload-area:hover, .upload-area.drag-over {
            background: rgba(74, 158, 255, 0.15);
            border-color: #6bb3ff;
        }

        .upload-area.drag-over {
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        #file-input {
            display: none;
        }

        .btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #4a9eff;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #3a8eef;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #00d084;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #00c077;
        }

        .btn-danger {
            background: #ff6b6b;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #ff5555;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .file-list {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(74, 158, 255, 0.1);
            border-radius: 8px;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            margin: 0.3rem 0;
            background: rgba(30, 30, 46, 0.5);
            border-radius: 6px;
        }

        .provider-badge {
            padding: 0.3rem 0.8rem;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge-uatl {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
        }

        .badge-umtn {
            background: rgba(74, 158, 255, 0.2);
            color: #4a9eff;
        }

        /* Statements Table */
        .table-section {
            background: rgba(30, 30, 46, 0.8);
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .table-header h2 {
            color: #4a9eff;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            background: rgba(30, 30, 46, 0.5);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: rgba(74, 158, 255, 0.2);
        }

        th {
            padding: 1rem;
            text-align: left;
            color: #4a9eff;
            font-weight: 600;
            border-bottom: 2px solid rgba(74, 158, 255, 0.5);
            white-space: nowrap;
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            user-select: text;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
        }

        tr:hover {
            background: rgba(74, 158, 255, 0.05);
        }

        .selectable {
            cursor: text;
            user-select: text;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
        }

        /* Status badges */
        .status-imported {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-weight: 600;
            display: inline-block;
        }

        .status-processed {
            background: rgba(74, 158, 255, 0.2);
            color: #4a9eff;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-weight: 600;
            display: inline-block;
        }

        .status-pass {
            background: rgba(0, 208, 132, 0.2);
            color: #00d084;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-weight: 600;
            display: inline-block;
        }

        .status-fail {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-weight: 600;
            display: inline-block;
        }

        .status-warning {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-weight: 600;
            display: inline-block;
        }

        /* Consolidated Status Colors */
        .status-import-failed {
            background: rgba(128, 128, 128, 0.2);
            color: #999;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-weight: 600;
            display: inline-block;
        }

        .status-imported {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-weight: 600;
            display: inline-block;
        }

        .status-verified {
            background: rgba(0, 208, 132, 0.2);
            color: #00d084;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-weight: 600;
            display: inline-block;
        }

        .status-verified-with-warnings {
            background: rgba(255, 152, 0, 0.2);
            color: #ff9800;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-weight: 600;
            display: inline-block;
        }

        .status-verification-failed {
            background: rgba(156, 39, 176, 0.2);
            color: #9c27b0;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-weight: 600;
            display: inline-block;
        }

        .status-flagged {
            background: rgba(244, 67, 54, 0.2);
            color: #f44336;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-weight: 600;
            display: inline-block;
        }

        /* Checkbox styling */
        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        #select-all {
            cursor: pointer;
        }

        /* Alert messages */
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .alert-success {
            background: rgba(0, 208, 132, 0.2);
            border-left: 4px solid #00d084;
            color: #00d084;
        }

        .alert-error {
            background: rgba(255, 107, 107, 0.2);
            border-left: 4px solid #ff6b6b;
            color: #ff6b6b;
        }

        .alert-info {
            background: rgba(74, 158, 255, 0.2);
            border-left: 4px solid #4a9eff;
            color: #4a9eff;
        }

        .hidden {
            display: none;
        }

        .spinner {
            border: 3px solid rgba(74, 158, 255, 0.3);
            border-top: 3px solid #4a9eff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 1rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .action-cell {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
            white-space: nowrap;
        }

        .legend {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(30, 30, 46, 0.5);
            border-radius: 8px;
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
            font-size: 0.9rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        .legend-yellow { background: rgba(255, 193, 7, 0.5); }
        .legend-blue { background: rgba(74, 158, 255, 0.5); }
        .legend-green { background: rgba(0, 208, 132, 0.5); }
        .legend-red { background: rgba(255, 107, 107, 0.5); }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üîç Multi-Provider Fraud Detection System</h1>
            <p>Upload ‚Üí Process ‚Üí Verify ‚Üí Download</p>
        </div>

        <!-- Step 1: Upload & Parse -->
        <div class="upload-section">
            <h2>üì§ Step 1: Upload & Parse Files</h2>
            <p style="color: #b0b0b0; margin-bottom: 1rem;">Select provider and upload statement files. Files will be parsed and saved to database.</p>

            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; color: #4a9eff; font-weight: 600;">Select Provider:</label>
                <select id="provider-select" style="padding: 0.8rem; border-radius: 8px; background: rgba(30, 30, 46, 0.8); color: #e0e0e0; border: 2px solid #4a9eff; font-size: 1rem; width: 300px; cursor: pointer;">
                    <option value="UATL">Airtel (UATL) - PDF or CSV</option>
                    <option value="UMTN">MTN (UMTN) - Excel or CSV</option>
                </select>
            </div>

            <div class="upload-area" id="upload-area">
                <div class="upload-icon">‚òÅÔ∏è</div>
                <h3>Drag and drop files here</h3>
                <p style="color: #b0b0b0; margin: 0.5rem 0;">or</p>
                <button class="btn btn-primary" onclick="document.getElementById('file-input').click()">
                    Browse Files
                </button>
                <p style="color: #888; margin-top: 1rem; font-size: 0.9rem;" id="supported-formats">Supports: PDF, CSV</p>
            </div>
            <input type="file" id="file-input" multiple accept=".pdf,.csv">

            <div id="file-list" class="file-list hidden"></div>

            <div style="margin-top: 1rem;">
                <button class="btn btn-primary" id="upload-btn" disabled onclick="uploadFiles()">
                    üöÄ Upload & Parse Files
                </button>
            </div>

            <div id="upload-status"></div>
        </div>

        <!-- Step 2: Statements Table -->
        <div class="table-section">
            <div class="table-header">
                <h2>üìã All Statements</h2>
                <div class="action-buttons">
                    <button class="btn btn-primary btn-sm" onclick="downloadAllSummary()">
                        üìä Download Summary (All)
                    </button>
                    <button class="btn btn-success btn-sm" id="process-selected-btn" disabled onclick="processSelected()">
                        ‚öôÔ∏è Process Selected
                    </button>
                    <button class="btn btn-danger btn-sm" id="delete-processed-btn" disabled onclick="deleteSelected(false)">
                        üóëÔ∏è Delete Processed
                    </button>
                    <button class="btn btn-danger btn-sm" id="delete-all-btn" disabled onclick="deleteSelected(true)">
                        üóëÔ∏è Delete All
                    </button>
                </div>
            </div>

            <!-- Search and Filter Controls -->
            <div style="background: rgba(74, 158, 255, 0.1); padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
                <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 1rem; align-items: end; margin-bottom: 1rem;">
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; color: #4a9eff; font-weight: 600;">Search:</label>
                        <input type="text" id="search-input" placeholder="Search by Run ID or Account Number"
                               style="width: 100%; padding: 0.6rem; border-radius: 6px; background: rgba(30, 30, 46, 0.8); color: #e0e0e0; border: 1px solid #4a9eff;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; color: #4a9eff; font-weight: 600;">Status:</label>
                        <select id="status-filter"
                                style="width: 100%; padding: 0.6rem; border-radius: 6px; background: rgba(30, 30, 46, 0.8); color: #e0e0e0; border: 1px solid #4a9eff;">
                            <option value="">All</option>
                            <option value="IMPORT_FAILED">Import Failed</option>
                            <option value="IMPORTED">Imported</option>
                            <option value="VERIFIED">Verified</option>
                            <option value="VERIFIED_WITH_WARNINGS">Verified with Warnings</option>
                            <option value="VERIFICATION_FAILED">Verification Failed</option>
                            <option value="FLAGGED">Flagged</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; color: #4a9eff; font-weight: 600;">Provider:</label>
                        <select id="provider-filter"
                                style="width: 100%; padding: 0.6rem; border-radius: 6px; background: rgba(30, 30, 46, 0.8); color: #e0e0e0; border: 1px solid #4a9eff;">
                            <option value="">All</option>
                            <option value="UATL">Airtel</option>
                            <option value="UMTN">MTN</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; color: #4a9eff; font-weight: 600;">RM Name:</label>
                        <input type="text" id="rm-name-input" placeholder="RM Name"
                               style="width: 100%; padding: 0.6rem; border-radius: 6px; background: rgba(30, 30, 46, 0.8); color: #e0e0e0; border: 1px solid #4a9eff;">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 1rem; align-items: end; margin-bottom: 1rem;">
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; color: #4a9eff; font-weight: 600;">From Date:</label>
                        <input type="date" id="from-date"
                               style="width: 100%; padding: 0.6rem; border-radius: 6px; background: rgba(30, 30, 46, 0.8); color: #e0e0e0; border: 1px solid #4a9eff;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; color: #4a9eff; font-weight: 600;">To Date:</label>
                        <input type="date" id="to-date"
                               style="width: 100%; padding: 0.6rem; border-radius: 6px; background: rgba(30, 30, 46, 0.8); color: #e0e0e0; border: 1px solid #4a9eff;">
                    </div>
                    <div></div>
                    <div></div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; align-items: end;">
                    <div>
                        <button class="btn btn-primary" onclick="applyFilters()" style="width: 100%;">
                            üîç Search
                        </button>
                    </div>
                    <div>
                        <button class="btn btn-sm" onclick="clearFilters()" style="width: 100%; background: #888; color: white;">
                            Clear Filters
                        </button>
                    </div>
                </div>
                <div style="margin-top: 1rem; display: flex; gap: 1rem; align-items: center;">
                    <label style="color: #4a9eff; font-weight: 600;">Page Size:</label>
                    <select id="page-size-select" onchange="changePageSize()"
                            style="padding: 0.5rem; border-radius: 6px; background: rgba(30, 30, 46, 0.8); color: #e0e0e0; border: 1px solid #4a9eff;">
                        <option value="10">10</option>
                        <option value="20" selected>20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
            </div>

            <div id="table-status"></div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="select-all" onchange="toggleSelectAll()"></th>
                            <th>Run ID</th>
                            <th>Provider</th>
                            <th>Account</th>
                            <th>RM Name</th>
                            <th>Rows</th>
                            <th>Imported</th>
                            <th>Status</th>
                            <th>Actions</th>
                            <th>Balance Match</th>
                            <th>Verification</th>
                            <th>Verification Reason</th>
                            <th>Import Error</th>
                            <th>Duplicates</th>
                            <th>Balance Diff Changes</th>
                            <th>Balance Diff Ratio</th>
                            <th>Calculated Balance</th>
                            <th>Statement Balance</th>
                            <th>Title</th>
                            <th>Author</th>
                            <th>Producer</th>
                            <th>Created At</th>
                            <th>Modified At</th>
                        </tr>
                    </thead>
                    <tbody id="statements-tbody">
                        <tr>
                            <td colspan="23" style="text-align: center; padding: 2rem; color: #888;">
                                Loading statements...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color legend-yellow"></div>
                    <span>Yellow = Imported (Not Processed)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color legend-blue"></div>
                    <span>Blue = Processed</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color legend-green"></div>
                    <span>Green = Verified/Pass</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color legend-red"></div>
                    <span>Red = Failed</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedFiles = [];
        let selectedRunIds = new Set();

        // Provider selection handler
        document.getElementById('provider-select').addEventListener('change', function() {
            const provider = this.value;
            const fileInput = document.getElementById('file-input');
            const formatsText = document.getElementById('supported-formats');

            if (provider === 'UATL') {
                fileInput.accept = '.pdf,.csv';
                formatsText.textContent = 'Supports: PDF, CSV (Airtel Money statements)';
            } else {
                fileInput.accept = '.xlsx,.xls,.csv';
                formatsText.textContent = 'Supports: Excel (XLSX, XLS), CSV';
            }

            // Clear selected files when provider changes
            fileInput.value = '';
            selectedFiles = [];
            document.getElementById('file-list').classList.add('hidden');
            document.getElementById('upload-btn').disabled = true;
        });

        // Drag and drop handlers
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => {
                uploadArea.classList.add('drag-over');
            }, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => {
                uploadArea.classList.remove('drag-over');
            }, false);
        });

        uploadArea.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            fileInput.files = files;
            handleFiles(files);
        }

        fileInput.addEventListener('change', function(e) {
            handleFiles(e.target.files);
        });

        function handleFiles(files) {
            selectedFiles = Array.from(files);
            if (selectedFiles.length === 0) return;

            document.getElementById('file-list').classList.remove('hidden');
            document.getElementById('upload-btn').disabled = false;

            // Get selected provider from dropdown
            const provider = document.getElementById('provider-select').value;
            const badgeClass = provider === 'UATL' ? 'badge-uatl' : 'badge-umtn';

            let html = '<h4 style="margin-bottom: 0.5rem; color: #4a9eff;">Selected Files:</h4>';
            selectedFiles.forEach(file => {
                html += `
                    <div class="file-item">
                        <span>üìÑ ${file.name}</span>
                        <span class="provider-badge ${badgeClass}">${provider}</span>
                    </div>
                `;
            });
            document.getElementById('file-list').innerHTML = html;
        }

        // Upload files
        async function uploadFiles() {
            const uploadBtn = document.getElementById('upload-btn');
            const statusDiv = document.getElementById('upload-status');
            const provider = document.getElementById('provider-select').value;

            uploadBtn.disabled = true;
            statusDiv.innerHTML = '<div class="spinner"></div><p style="text-align: center;">Uploading and parsing files...</p>';

            const formData = new FormData();
            selectedFiles.forEach(file => {
                formData.append('files', file);
            });

            try {
                const response = await fetch(`/api/v1/upload?provider=${provider}`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.successful > 0) {
                    statusDiv.innerHTML = `
                        <div class="alert alert-success">
                            ‚úÖ Successfully uploaded and parsed ${result.successful} file(s)
                        </div>
                    `;
                } else {
                    statusDiv.innerHTML = `
                        <div class="alert alert-error">
                            ‚ùå No files were uploaded successfully
                        </div>
                    `;
                }

                // Clear form
                fileInput.value = '';
                selectedFiles = [];
                document.getElementById('file-list').classList.add('hidden');
                uploadBtn.disabled = true;

                // Reload table
                await loadStatements();

            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="alert alert-error">
                        ‚ùå Error: ${error.message}
                    </div>
                `;
                uploadBtn.disabled = false;
            }
        }

        // State variables for pagination and filtering
        let currentPage = 1;
        let currentPageSize = 20;
        let currentSearch = '';
        let currentStatus = '';  // Consolidated status
        let currentProvider = '';
        let currentRmName = '';
        let currentFromDate = '';
        let currentToDate = '';

        // Load statements table
        async function loadStatements(page = 1) {
            try {
                currentPage = page;

                // Build query parameters
                const params = new URLSearchParams({
                    page: currentPage,
                    page_size: currentPageSize
                });

                if (currentSearch) params.append('search', currentSearch);
                if (currentStatus) params.append('status', currentStatus);
                if (currentProvider) params.append('acc_prvdr_code', currentProvider);
                if (currentRmName) params.append('rm_name', currentRmName);
                if (currentFromDate) params.append('from_date', currentFromDate);
                if (currentToDate) params.append('to_date', currentToDate);

                const response = await fetch(`/api/v1/unified-list?${params.toString()}`);
                const data = await response.json();

                const tbody = document.getElementById('statements-tbody');

                if (data.items.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="23" style="text-align: center; padding: 2rem; color: #888;">
                                No statements found. Try adjusting your filters or upload files above.
                            </td>
                        </tr>
                    `;
                    updatePagination(data.pagination);
                    return;
                }

                let html = '';
                data.items.forEach(item => {
                    // Get consolidated status CSS class
                    const statusClass = getStatusClass(item.status);
                    const statusLabel = getStatusLabel(item.status);
                    const balanceMatchBadge = getBalanceMatchBadge(item);
                    const verificationBadge = getVerificationBadge(item);
                    const verificationReason = getVerificationReason(item);
                    const providerName = item.acc_prvdr_code === 'UATL' ? 'Airtel' : 'MTN';

                    html += `
                        <tr>
                            <td><input type="checkbox" class="row-checkbox" data-run-id="${item.run_id}" data-status="${item.status}" data-acc-number="${item.acc_number || 'unknown'}"></td>
                            <td><span class="selectable">${item.run_id}</span></td>
                            <td>${providerName}</td>
                            <td>${item.acc_number || 'N/A'}</td>
                            <td>${item.rm_name || 'N/A'}</td>
                            <td>${item.num_rows || 0}</td>
                            <td>${formatDate(item.imported_at)}</td>
                            <td><span class="${statusClass}">${statusLabel}</span></td>
                            <td>
                                <div class="action-cell">
                                    ${item.status === 'VERIFIED' || item.status === 'VERIFIED_WITH_WARNINGS' || item.status === 'VERIFICATION_FAILED' || item.status === 'FLAGGED' ?
                                        `<button class="btn btn-sm btn-primary" onclick="downloadProcessed('${item.run_id}', '${item.acc_number || 'unknown'}')">üì• Download</button>` :
                                        item.status === 'IMPORTED' ?
                                        `<button class="btn btn-sm btn-success" onclick="processSingle('${item.run_id}')">‚öôÔ∏è Process</button>` :
                                        '-'
                                    }
                                </div>
                            </td>
                            <td>${balanceMatchBadge}</td>
                            <td>${verificationBadge}</td>
                            <td>${verificationReason}</td>
                            <td>${item.parsing_error || '-'}</td>
                            <td>${item.duplicate_count !== null && item.duplicate_count !== undefined ? item.duplicate_count : '-'}</td>
                            <td>${item.balance_diff_changes !== null && item.balance_diff_changes !== undefined ? item.balance_diff_changes : '-'}</td>
                            <td>${item.balance_diff_change_ratio !== null && item.balance_diff_change_ratio !== undefined ? item.balance_diff_change_ratio.toFixed(4) : '-'}</td>
                            <td>${item.calculated_closing_balance !== null && item.calculated_closing_balance !== undefined ? formatNumber(item.calculated_closing_balance) : '-'}</td>
                            <td>${item.stmt_closing_balance !== null && item.stmt_closing_balance !== undefined ? formatNumber(item.stmt_closing_balance) : '-'}</td>
                            <td><span class="selectable">${item.meta_title || 'N/A'}</span></td>
                            <td><span class="selectable">${item.meta_author || 'N/A'}</span></td>
                            <td><span class="selectable">${item.meta_producer || 'N/A'}</span></td>
                            <td>${formatDate(item.meta_created_at)}</td>
                            <td>${formatDate(item.meta_modified_at)}</td>
                        </tr>
                    `;
                });

                tbody.innerHTML = html;

                // Update pagination controls
                updatePagination(data.pagination);

                // Add checkbox listeners
                document.querySelectorAll('.row-checkbox').forEach(cb => {
                    cb.addEventListener('change', updateSelectedCount);
                });

            } catch (error) {
                console.error('Error loading statements:', error);
                document.getElementById('statements-tbody').innerHTML = `
                    <tr>
                        <td colspan="23" style="text-align: center; padding: 2rem; color: #ff6b6b;">
                            Error loading statements: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        function formatDateOnly(dateStr) {
            if (!dateStr) return 'N/A';
            try {
                const date = new Date(dateStr);
                return date.toLocaleDateString();
            } catch {
                return 'N/A';
            }
        }

        function updatePagination(pagination) {
            const tbody = document.getElementById('statements-tbody');
            const paginationDiv = document.getElementById('pagination-controls') || createPaginationDiv();

            if (!pagination || pagination.total === 0) {
                paginationDiv.innerHTML = '';
                return;
            }

            const { page, page_size, total, total_pages } = pagination;

            let html = '<div style="padding: 1rem; text-align: center; background: rgba(30, 30, 46, 0.5); border-radius: 8px; margin-top: 1rem;">';
            html += `<p style="color: #b0b0b0; margin-bottom: 1rem;">Page ${page} of ${total_pages} (Total: ${total} statements)</p>`;
            html += '<div style="display: flex; justify-content: center; gap: 0.5rem; flex-wrap: wrap;">';

            // Previous button
            if (page > 1) {
                html += `<button class="btn btn-sm btn-primary" onclick="loadStatements(${page - 1})">‚Üê Previous</button>`;
            }

            // Page numbers (show first, last, and pages around current)
            for (let i = 1; i <= total_pages; i++) {
                if (i === 1 || i === total_pages || (i >= page - 2 && i <= page + 2)) {
                    const activeClass = i === page ? 'style="background: #6bb3ff;"' : '';
                    html += `<button class="btn btn-sm btn-primary" ${activeClass} onclick="loadStatements(${i})">${i}</button>`;
                } else if (i === page - 3 || i === page + 3) {
                    html += '<span style="color: #888; padding: 0 0.5rem;">...</span>';
                }
            }

            // Next button
            if (page < total_pages) {
                html += `<button class="btn btn-sm btn-primary" onclick="loadStatements(${page + 1})">Next ‚Üí</button>`;
            }

            html += '</div></div>';
            paginationDiv.innerHTML = html;
        }

        function createPaginationDiv() {
            const div = document.createElement('div');
            div.id = 'pagination-controls';
            document.querySelector('.table-container').appendChild(div);
            return div;
        }

        function applyFilters() {
            currentSearch = document.getElementById('search-input').value.trim();
            currentStatus = document.getElementById('status-filter').value;
            currentProvider = document.getElementById('provider-filter').value;
            currentRmName = document.getElementById('rm-name-input').value.trim();
            currentFromDate = document.getElementById('from-date').value;
            currentToDate = document.getElementById('to-date').value;
            currentPage = 1; // Reset to first page when filtering
            loadStatements(1);
        }

        function clearFilters() {
            document.getElementById('search-input').value = '';
            document.getElementById('status-filter').value = '';
            document.getElementById('provider-filter').value = '';
            document.getElementById('rm-name-input').value = '';
            document.getElementById('from-date').value = '';
            document.getElementById('to-date').value = '';
            currentSearch = '';
            currentStatus = '';
            currentProvider = '';
            currentRmName = '';
            currentFromDate = '';
            currentToDate = '';
            currentPage = 1;
            loadStatements(1);
        }

        function changePageSize() {
            currentPageSize = parseInt(document.getElementById('page-size-select').value);
            currentPage = 1; // Reset to first page when changing page size
            loadStatements(1);
        }

        // Allow Enter key to trigger search
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('search-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    applyFilters();
                }
            });
        });

        function getBalanceMatchBadge(item) {
            if (item.processing_status === 'IMPORTED') {
                return '<span style="color: #888;">Not Processed</span>';
            }

            if (item.balance_match === 'Success') {
                return '<span class="status-pass">Success</span>';
            } else if (item.balance_match === 'Failed') {
                return '<span class="status-fail">Failed</span>';
            }
            return '<span style="color: #888;">-</span>';
        }

        function getVerificationBadge(item) {
            if (item.processing_status === 'IMPORTED') {
                return '<span style="color: #888;">-</span>';
            }

            if (item.verification_status === 'PASS') {
                return '<span class="status-pass">PASS</span>';
            } else if (item.verification_status === 'FAIL') {
                return '<span class="status-fail">FAIL</span>';
            } else if (item.verification_status === 'WARNING') {
                return '<span class="status-warning">WARNING</span>';
            }
            return '<span style="color: #888;">N/A</span>';
        }

        function getVerificationReason(item) {
            if (item.processing_status === 'IMPORTED') {
                return '<span style="color: #888;">-</span>';
            }

            if (item.verification_reason) {
                // Truncate to 50 characters
                const reason = item.verification_reason.length > 50
                    ? item.verification_reason.substring(0, 50) + '...'
                    : item.verification_reason;
                return `<span title="${item.verification_reason}">${reason}</span>`;
            }
            return '<span style="color: #888;">-</span>';
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            const date = new Date(dateStr);
            return date.toLocaleString();
        }

        function getStatusClass(status) {
            const classMap = {
                'IMPORT_FAILED': 'status-import-failed',
                'IMPORTED': 'status-imported',
                'VERIFIED': 'status-verified',
                'VERIFIED_WITH_WARNINGS': 'status-verified-with-warnings',
                'VERIFICATION_FAILED': 'status-verification-failed',
                'FLAGGED': 'status-flagged'
            };
            return classMap[status] || 'status-imported';
        }

        function getStatusLabel(status) {
            const labelMap = {
                'IMPORT_FAILED': 'Import Failed',
                'IMPORTED': 'Imported',
                'VERIFIED': 'Verified',
                'VERIFIED_WITH_WARNINGS': 'Verified with Warnings',
                'VERIFICATION_FAILED': 'Verification Failed',
                'FLAGGED': 'Flagged'
            };
            return labelMap[status] || status;
        }

        function formatNumber(num) {
            if (num === null || num === undefined) return 'N/A';
            return new Intl.NumberFormat('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(num);
        }

        // Select all checkbox
        function toggleSelectAll() {
            const selectAll = document.getElementById('select-all');
            const checkboxes = document.querySelectorAll('.row-checkbox');

            checkboxes.forEach(cb => {
                cb.checked = selectAll.checked;
            });

            updateSelectedCount();
        }

        function updateSelectedCount() {
            selectedRunIds.clear();
            let importedCount = 0;
            let processedCount = 0;

            document.querySelectorAll('.row-checkbox:checked').forEach(cb => {
                selectedRunIds.add(cb.dataset.runId);
                if (cb.dataset.status === 'IMPORTED') {
                    importedCount++;
                } else {
                    processedCount++;
                }
            });

            // Enable process button only if IMPORTED statements are selected
            document.getElementById('process-selected-btn').disabled = importedCount === 0;

            // Enable delete buttons if any statements are selected
            document.getElementById('delete-processed-btn').disabled = selectedRunIds.size === 0;
            document.getElementById('delete-all-btn').disabled = selectedRunIds.size === 0;
        }

        // Process selected
        async function processSelected() {
            if (selectedRunIds.size === 0) return;

            const statusDiv = document.getElementById('table-status');
            statusDiv.innerHTML = '<div class="spinner"></div><p style="text-align: center;">Processing selected statements...</p>';

            try {
                const response = await fetch('/api/v1/process', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({run_ids: Array.from(selectedRunIds)})
                });

                const result = await response.json();

                // Count skipped statements
                const skipped = result.results.filter(r => r.status === 'skipped').length;

                let message = '';
                if (result.successful > 0) {
                    message += `‚úÖ Successfully processed ${result.successful} statement(s)<br>`;
                }
                if (skipped > 0) {
                    message += `‚è≠Ô∏è Skipped ${skipped} statement(s) (already processed)<br>`;
                }
                if (result.failed > 0) {
                    message += `‚ùå Failed to process ${result.failed} statement(s)`;
                }

                statusDiv.innerHTML = `<div class="alert alert-success">${message}</div>`;

                // Reload table
                selectedRunIds.clear();
                await loadStatements();

            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="alert alert-error">
                        ‚ùå Error: ${error.message}
                    </div>
                `;
            }
        }

        // Process single
        async function processSingle(runId) {
            const statusDiv = document.getElementById('table-status');
            statusDiv.innerHTML = '<div class="spinner"></div><p style="text-align: center;">Processing statement...</p>';

            try {
                const response = await fetch('/api/v1/process', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({run_ids: [runId]})
                });

                const result = await response.json();

                const firstResult = result.results[0];
                let message = '';
                let alertClass = 'alert-success';

                if (firstResult.status === 'success') {
                    message = '‚úÖ Statement processed successfully';
                } else if (firstResult.status === 'skipped') {
                    message = '‚è≠Ô∏è Statement was already processed, skipped';
                    alertClass = 'alert-info';
                } else {
                    message = `‚ùå Error: ${firstResult.message}`;
                    alertClass = 'alert-error';
                }

                statusDiv.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;

                await loadStatements();

            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="alert alert-error">
                        ‚ùå Error: ${error.message}
                    </div>
                `;
            }
        }

        // Delete selected
        async function deleteSelected(deleteAll) {
            if (selectedRunIds.size === 0) return;

            const action = deleteAll ? 'delete all data (including raw)' : 'delete processed data';
            if (!confirm(`Are you sure you want to ${action} for ${selectedRunIds.size} statement(s)?`)) {
                return;
            }

            const statusDiv = document.getElementById('table-status');
            statusDiv.innerHTML = '<div class="spinner"></div><p style="text-align: center;">Deleting data...</p>';

            try {
                const response = await fetch('/api/v1/delete', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        run_ids: Array.from(selectedRunIds),
                        delete_all: deleteAll,
                        confirm: true
                    })
                });

                const result = await response.json();

                statusDiv.innerHTML = `
                    <div class="alert alert-success">
                        ‚úÖ Successfully deleted ${result.successful} statement(s)
                    </div>
                `;

                selectedRunIds.clear();
                await loadStatements();

            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="alert alert-error">
                        ‚ùå Error: ${error.message}
                    </div>
                `;
            }
        }

        // Download summary for all statements
        async function downloadAllSummary() {
            try {
                const filename = `summary_all_statements.csv`;
                const response = await fetch(`/api/v1/download/summary?format=csv`);

                if (!response.ok) {
                    throw new Error('Download failed');
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } catch (error) {
                alert('Error downloading summary: ' + error.message);
            }
        }

        // Download processed statements for specific run_id
        async function downloadProcessed(runId, accNumber) {
            try {
                const filename = `${accNumber}_${runId}.csv`;
                const response = await fetch(`/api/v1/download/processed?run_id=${runId}&format=csv`);

                if (!response.ok) {
                    throw new Error('Download failed');
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } catch (error) {
                alert('Error downloading processed statements: ' + error.message);
            }
        }

        // Load statements on page load
        loadStatements();

        // Refresh every 10 seconds
        setInterval(loadStatements, 10000);
    </script>
</body>
</html>
